<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>أشطر بنوته ف الدنيا ❤️ — لينا الإصدار العالمي</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-top:#e8f7ff;
    --bg-bottom:#ffffff;
    --primary:#2563eb;
    --accent:#3b82f6;
    --muted:#64748b;
    --success:#16a34a;
    --danger:#ef4444;
    --card-bg: rgba(255,255,255,0.98);
    --text:#0f172a;
    --pink:#ec4899;
  }
  *{box-sizing:border-box}
  body,html{height:100%;margin:0;font-family:"Cairo",sans-serif;background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));color:var(--text);-webkit-font-smoothing:antialiased}
  .stage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
  .card { width:100%; max-width:980px; border-radius:18px; background:var(--card-bg); box-shadow:0 30px 70px rgba(15,23,42,0.08); padding:30px; text-align:center; position:relative; overflow:hidden }

  /* welcome overlay */
  .welcome {
    position:absolute; inset:0; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.92));
    display:flex; align-items:center; justify-content:center; flex-direction:column; padding:28px;
    transition:opacity .45s ease, transform .45s ease; z-index:40;
  }
  .welcome.hidden { opacity:0; pointer-events:none; transform:translateY(-10px) }
  .welcome h2{font-size:26px;margin:8px 0 6px;color:var(--primary); font-weight:800}
  .welcome p{margin:6px 0 18px;color:var(--muted); font-size:16px}
  .welcome .big-cta{padding:14px 22px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),#06b6d4); color:white; font-size:18px;font-weight:800; cursor:pointer; box-shadow:0 12px 36px rgba(59,130,246,0.16)}
  .welcome .small{display:flex; gap:8px; margin-top:12px; align-items:center}
  .resume-banner{background:linear-gradient(90deg,#fef3c7,#fef08a); padding:8px 12px; border-radius:12px; font-weight:700; color:#92400e; display:inline-flex; gap:12px; align-items:center}

  /* header */
  .hearts{display:flex;gap:10px;justify-content:center;margin-bottom:8px}
  .hearts span{font-size:20px;color:rgba(59,130,246,0.6)}
  h1.title{margin:6px 0 12px;font-size:34px;color:var(--primary);font-weight:700}
  .divider{height:6px;width:140px;margin:12px auto;border-radius:6px;background:linear-gradient(90deg,#60a5fa,#34d399)}
  .icon-book{font-size:44px;color:#34d399;margin-bottom:12px}
  .subtitle{margin:0 0 18px;color:rgba(15,23,42,0.6);font-size:15px}

  /* controls (home) */
  .controls{display:flex;flex-direction:column;gap:12px;align-items:center; justify-content:center}
  .primary-btn{
    width:84%; max-width:520px; padding:14px 18px;border-radius:12px;border:none;
    background:linear-gradient(90deg,var(--accent),#06b6d4); color:white; font-size:18px;font-weight:800;
    cursor:pointer; box-shadow:0 12px 36px rgba(59,130,246,0.16);
    transition:transform .14s ease,box-shadow .14s ease;
  }
  .primary-btn:hover{transform:translateY(-3px);box-shadow:0 20px 48px rgba(59,130,246,0.22)}
  .file-btn{
    width:84%; max-width:520px; padding:12px;border-radius:12px;border:1px solid rgba(37,99,235,0.12);
    background:transparent;color:var(--text);font-weight:700;cursor:pointer;font-size:16px;
  }
  .flex-row{display:flex;gap:12px;justify-content:center;align-items:center;width:100%;flex-wrap:wrap;margin-top:8px}

  /* Mode selection cards */
  .modes{display:flex;gap:18px;justify-content:center;margin-top:18px;flex-wrap:wrap}
  .mode-card{
    flex:1 1 300px; max-width:440px; background:rgba(255,255,255,0.96); border-radius:12px; padding:20px;
    box-shadow:0 8px 30px rgba(2,6,23,0.04); text-align:center;
  }
  .mode-icon{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:28px}
  .mc .mode-icon{background:rgba(59,130,246,0.12); color:var(--accent)}
  .type .mode-icon{background:rgba(16,185,129,0.08); color:#10b981}
  .mode-title{font-weight:800;font-size:20px;margin-bottom:8px}
  .mode-desc{color:var(--muted); margin-bottom:14px}
  .mode-start{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;font-weight:800;cursor:pointer}

  /* difficulty */
  .difficulty{display:flex;gap:10px;justify-content:center; margin-top:10px}
  .diff-btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(37,99,235,0.12); background:transparent; cursor:pointer; font-weight:800}

  /* quiz */
  .quiz{margin-top:22px;display:none}
  .progress-wrap{width:92%;max-width:760px;margin:8px auto}
  #progressBarContainer{width:100%;background:#eef2ff;height:34px;border-radius:999px;overflow:hidden;position:relative}
  #progressBar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa);transition:width .45s ease}
  #progressText{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;text-shadow:0 1px 2px rgba(0,0,0,0.25);font-size:14px}

  #question{font-size:20px;margin:18px 0;padding:14px;border-radius:10px;background:rgba(2,6,23,0.03); min-height:64px; display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .25s ease}
  .speak-btn{ background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--primary); }
  .options{display:flex;flex-direction:column;gap:12px;align-items:center;margin-bottom:12px}
  .option{width:90%;max-width:680px;padding:12px 16px;border-radius:12px;background:var(--accent);color:white;font-weight:700;cursor:pointer;box-shadow:0 12px 34px rgba(59,130,246,0.12);transition:transform .12s, box-shadow .12s}
  .option:hover{transform:translateY(-3px)}
  .option.correct{background:var(--success) !important}
  .option.wrong{background:var(--danger) !important}

  /* typing mode */
  .type-input{width:80%;max-width:520px;padding:12px;border-radius:10px;border:2px solid rgba(37,99,235,0.12);text-align:center;font-weight:700;font-size:16px}

  #feedback{margin-top:10px;font-weight:800;min-height:28px}

  /* review */
  .review{display:none;margin-top:18px}
  .review-list{max-height:360px;overflow:auto;margin:12px auto;width:92%;max-width:760px;text-align:right}
  .review-item{display:flex;justify-content:space-between;align-items:center;background:#f0f9f1;color:var(--success);font-size:20px;font-weight:900;padding:12px 14px;border-radius:10px;margin:8px 0}
  .review-item .mean{color:var(--text);font-size:18px;font-weight:700;opacity:0.95;margin-left:10px}
  .play-icon{background:transparent;border:none;font-size:18px;color:var(--primary);cursor:pointer;margin-left:8px}

  .review-controls{display:flex;gap:12px;justify-content:center;margin-top:12px}
  .btn-ghost{padding:10px 14px;border-radius:10px;border:1px solid rgba(37,99,235,0.12);background:transparent;cursor:pointer;font-weight:700}
  .btn-home{padding:12px 16px;border-radius:12px;border:none;background:#64748b;color:white;font-weight:800;cursor:pointer}

  .final-msg{display:none;margin-top:16px;font-size:22px;color:var(--primary);font-weight:900}

  .note{margin-top:14px;color:rgba(15,23,42,0.6);font-size:13px}

  /* stars area */
  .stars-wrap{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:12px}
  .star{font-size:28px; opacity:0.25; transition:transform .25s, opacity .25s}
  .star.active{opacity:1; transform:scale(1.12)}

  /* secret message */
  #secretMessage {
    display:none; position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:white; padding:26px 28px; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,0.18);
    text-align:center; font-size:20px; font-weight:800; color:#e11d48; z-index:99999; animation:fadeIn 0.6s ease;
    max-width:92%;
  }
  #secretMessage .close { margin-top:12px; padding:8px 12px; border-radius:10px; border:none; background:linear-gradient(90deg,var(--accent),#06b6d4); color:white; font-weight:800; cursor:pointer; }

  @keyframes fadeIn {
    from {opacity:0; transform:translate(-50%,-60%);}
    to {opacity:1; transform:translate(-50%,-50%);}
  }

  /* confetti canvas full */
  #confetti { position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:9998 }

  @media (max-width:900px){
    .mode-card{max-width:100%}
    h1.title{font-size:26px}
    .primary-btn{width:90%}
    .option{font-size:16px}
  }
</style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="stage">
    <main class="card" role="main" aria-labelledby="main-title">

      <!-- WELCOME overlay -->
      <div id="welcome" class="welcome">
        <div class="resume-area" id="resumeArea" style="display:none">
          <div class="resume-banner">يوجد حفظ سابق — <button id="resumeBtn" class="diff-btn">استكمال من حيث توقفت</button></div>
        </div>

        <h2>جاهزة نبدأ شوية إنجليزي؟ 😍</h2>
        <p>يلا يا مزه نذاكر إنجليزي 💪❤️</p>
        <button id="beginBtn" class="big-cta">ابدئي دلوقتي ✨📘</button>

        <div class="small">
          <label class="file-btn" for="fileInput" title="رفع ملف الكلمات الخاصة">
            رفع كلمات خاصة 📁
            <input id="fileInput" type="file" accept=".txt" style="display:none" aria-label="اختر ملف txt" />
          </label>
          <div style="width:10px"></div>
          <div style="color:var(--muted);font-weight:700">اختر مستوى وسواء في نهاية تشوف مفاجأة 💌</div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:800;color:var(--muted)">اختر مستوى الصعوبة:</div>
          <div class="difficulty" style="margin-top:8px">
            <button class="diff-btn" data-diff="easy">سهل (10)</button>
            <button class="diff-btn" data-diff="medium">متوسط (20)</button>
            <button class="diff-btn" data-diff="hard">صعب (كل الكلمات)</button>
          </div>
        </div>
      </div>

      <!-- main card content (under overlay) -->
      <div class="hearts" id="hearts"><span>❤</span><span>❤</span><span style="opacity:0.7">❤</span></div>
      <h1 id="main-title" class="title">أشطر بنوته ف الدنيا ❤️</h1>
      <div class="divider" id="divider" aria-hidden="true"></div>
      <div class="icon-book" id="icon-book">📘</div>
      <p class="subtitle" id="subtitle">Ready to learn some English?</p>

      <!-- HOME controls -->
      <div class="controls" id="homeControls" aria-label="home controls" style="display:none">
        <button id="startBtn" class="primary-btn" aria-label="ابدأ الاختبار">ابدأ الاختبار</button>
      </div>

      <!-- MODE selection -->
      <section class="modes" id="modesSection" style="display:none" aria-label="اختيار وضع الاختبار">
        <div class="mode-card mc" role="article">
          <div class="mode-icon"><span>✓</span></div>
          <div class="mode-title">Multiple Choice</div>
          <div class="mode-desc">See an English word and choose the correct Arabic meaning from 4 options</div>
          <button class="mode-start" id="startMC">ابدئي وضع الاختيارات 🎯</button>
        </div>

        <div class="mode-card type" role="article">
          <div class="mode-icon"><span>✍️</span></div>
          <div class="mode-title">Type the Word</div>
          <div class="mode-desc">See the Arabic meaning and type the correct English word</div>
          <button class="mode-start" id="startType">ابدئي وضع الكتابة ✍️</button>
        </div>
      </section>

      <!-- QUIZ block -->
      <section class="quiz" id="quizBlock" aria-live="polite">
        <div class="progress-wrap">
          <div id="progressBarContainer">
            <div id="progressBar"></div>
            <div id="progressText">0/0 سؤال</div>
          </div>
        </div>

        <div id="question"><span id="questionText">السؤال سيظهر هنا</span>
          <button id="speakQuestion" class="speak-btn" title="اسمع النطق">🔊</button>
        </div>

        <div class="options" id="options"></div>

        <!-- typing input -->
        <div id="typeArea" style="display:none">
          <input id="typeInput" class="type-input" type="text" placeholder="اكتبي الكلمة بالإنجليزي ثم اضغطي Enter" />
        </div>

        <div id="feedback" aria-live="assertive"></div>

        <div class="stars-wrap" id="starsWrap" title="نجوم الإنجاز">
          <div class="star" id="star1">⭐</div>
          <div class="star" id="star2">⭐</div>
          <div class="star" id="star3">⭐</div>
          <div class="star" id="star4">⭐</div>
          <div class="star" id="star5">⭐</div>
        </div>

        <div class="flex-row" style="margin-top:12px">
          <button id="homeBtnFixed" class="btn-home" style="">🏠 رجوع للصفحة الرئيسية</button>
          <button id="saveBtn" class="btn-ghost">💾 حفظ التقدّم</button>
        </div>
      </section>

      <!-- review -->
      <section class="review" id="reviewBlock" aria-live="polite">
        <h3>الكلمات اللي غلطتي فيها 📘</h3>
        <div class="review-list" id="reviewList"></div>
        <div class="review-controls">
          <button id="retryBtn" class="primary-btn" style="display:none">إعادة الاختبار على الكلمات الغلط</button>
          <button id="homeBtn" class="btn-home">رجوع للصفحة الرئيسية</button>
        </div>
        <div class="final-msg" id="finalMsg">وااااااااو 😍 شطورة أوي أوي والله ❤️</div>
      </section>

      <p class="note">ارفع ملف .txt بصيغة: <em>book=كتاب</em> أو <em>book كتاب</em> أو <em>book-كتاب</em>. الملف يجب أن يكون UTF-8 إذا فيه عربي.</p>
    </main>
  </div>

  <!-- SECRET MESSAGE -->
  <div id="secretMessage" role="dialog" aria-modal="true" aria-hidden="true">
    أنا فخور بيكي أوي أوي يا قطتي ❤️<br>
    وشايفك أشطر بنوته في العالم كله 🥰
    <div><button class="close" id="secretClose">حلو! ❤️</button></div>
  </div>

<script>
/* ========= state ========= */
let originalWords = []; // [{en,ar},...]
let words = [];         // current round words
let current = 0;
let mistakes = [];      // collects wrong answers (can contain duplicates across rounds)
let mode = null;        // "mc" or "type"
let correctCount = 0;
let starsEarned = 0;
let difficulty = 'medium'; // default
const localKey = 'lina_quiz_v1_state';

const msgsCorrect = ["أشطر لينا ❤️","شطوره يا بطتي ❤️","شطوره يا قطتي ❤️","ايه الشطارة دي يا مزتي ❤️"];
const msgsWrong = ["نركز يا قطتي ❤️","فيه احسن يا مزه ❤️","عادي يا حبيبي نحفظ تاني ❤️"];

/* ====== elements ====== */
const fileInput = document.getElementById('fileInput');
const beginBtn = document.getElementById('beginBtn');
const welcome = document.getElementById('welcome');
const resumeArea = document.getElementById('resumeArea');
const resumeBtn = document.getElementById('resumeBtn');
const beginDiffButtons = document.querySelectorAll('.diff-btn[data-diff]');
const homeControls = document.getElementById('homeControls');
const modesSection = document.getElementById('modesSection');
const startMC = document.getElementById('startMC');
const startType = document.getElementById('startType');
const quizBlock = document.getElementById('quizBlock');
const questionEl = document.getElementById('question');
const questionText = document.getElementById('questionText');
const optionsEl = document.getElementById('options');
const typeArea = document.getElementById('typeArea');
const typeInput = document.getElementById('typeInput');
const feedbackEl = document.getElementById('feedback');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const reviewBlock = document.getElementById('reviewBlock');
const reviewList = document.getElementById('reviewList');
const retryBtn = document.getElementById('retryBtn');
const homeBtn = document.getElementById('homeBtn');
const homeBtnFixed = document.getElementById('homeBtnFixed');
const startBtn = document.getElementById('startBtn');
const speakQuestionBtn = document.getElementById('speakQuestion');
const finalMsg = document.getElementById('finalMsg');
const secretMessage = document.getElementById('secretMessage');
const secretClose = document.getElementById('secretClose');
const saveBtn = document.getElementById('saveBtn');
const starsWrap = document.getElementById('starsWrap');
const starEls = [document.getElementById('star1'),document.getElementById('star2'),document.getElementById('star3'),document.getElementById('star4'),document.getElementById('star5')];
const confettiCanvas = document.getElementById('confetti');
const resumeAvailable = checkSavedState();

/* ====== default words ====== */
const defaultWords = [
  { en: "duty", ar: "واجب - وظيفة" },
  { en: "emergency", ar: "حالة طوارئ" },
  { en: "flood", ar: "يغمر - فيضان" },
  { en: "obligation", ar: "التزام - واجب" },
  { en: "protect", ar: "يحمي - يحافظ" },
  { en: "rescue", ar: "ينقذ" },
  { en: "risk", ar: "يتخذ مخاطرة" },
  { en: "risky", ar: "خطير - محفوف بالمخاطر" },
  { en: "truth", ar: "حقيقة" },
  { en: "accident", ar: "حادث" },
  { en: "act", ar: "يفعل - يتصرف" },
  { en: "aspect", ar: "جانب" },
  { en: "believe in", ar: "يؤمن بـ" },
  { en: "breathe", ar: "يتنفس" },
  { en: "crowded", ar: "مزدحم" },
  { en: "damp", ar: "رطب" },
  { en: "debate", ar: "نقاش" },
  { en: "descriptive", ar: "وصفى" },
  { en: "drown", ar: "يغرق" },
  { en: "fear", ar: "خوف" },
  { en: "fire", ar: "نار - حريق" },
  { en: "firefighter", ar: "رجل إطفاء" },
  { en: "forever", ar: "إلى الأبد" },
  { en: "hope", ar: "أمل" },
  { en: "injured", ar: "مصاب" },
  { en: "ladder", ar: "سلم" },
  { en: "lifeguard", ar: "منقذ" },
  { en: "moss", ar: "طحالب" },
  { en: "overall", ar: "إجمالي - عام" },
  { en: "pine needle", ar: "إبرة الصنوبر" },
  { en: "put out", ar: "يطفئ" },
  { en: "rustling", ar: "خفيف (أصوات الأوراق)" },
  { en: "sadly", ar: "بأسف" },
  { en: "save", ar: "ينقذ - يحفظ" },
  { en: "scenario", ar: "سيناريو" },
  { en: "serious", ar: "خطير - جاد" },
  { en: "serve", ar: "يخدم" },
  { en: "service", ar: "خدمة" },
  { en: "stand-stood-stood", ar: "يقف" },
  { en: "storm", ar: "عاصفة" },
  { en: "summarize", ar: "يلخص" },
  { en: "texture", ar: "نسيج - قوام" },
  { en: "training", ar: "تدريب" },
  { en: "trap", ar: "يحبس - يخدع" },
  { en: "voluntary", ar: "تطوعي" },
  { en: "worth", ar: "يستحق" },
  { en: "yet", ar: "ما زال - بعد" }
];

/* ====== utility ====== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function dedupeKeepOrder(arr){ const seen=new Set(); const out=[]; arr.forEach(it=>{ if(!it) return; const key=`${it.en}|||${it.ar}`; if(!seen.has(key)){ seen.add(key); out.push(it); }}); return out; }
function checkSavedState(){ try{ const s = localStorage.getItem(localKey); return !!s; }catch(e){ return false; }}

/* ====== WebAudio simple sounds for correct/wrong ====== */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
function playTone(freq, type='sine', duration=0.12, gain=0.12){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + duration);
}
function playCorrect(){
  // quick arpeggio
  playTone(880,'sine',0.08,0.08);
  setTimeout(()=>playTone(1100,'sine',0.08,0.06),70);
}
function playWrong(){
  playTone(220,'sawtooth',0.18,0.12);
}

/* ====== confetti simple implementation ====== */
const confettiCtx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;
let confettiParticles = [];
function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener('resize',resizeCanvas); resizeCanvas();
function spawnConfetti(amount=40){
  confettiParticles = [];
  for(let i=0;i<amount;i++){
    confettiParticles.push({
      x: Math.random()*confettiCanvas.width,
      y: Math.random()*confettiCanvas.height - confettiCanvas.height/2,
      vx: (Math.random()-0.5)*6,
      vy: Math.random()*6+2,
      size: Math.random()*8+6,
      color: `hsl(${Math.random()*360} 75% 60%)`,
      rot: Math.random()*360,
      rotSpeed: (Math.random()-0.5)*10
    });
  }
  requestAnimationFrame(confettiFrame);
}
let confettiFrameId = null;
function confettiFrame(){
  if(!confettiCtx) return;
  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  for(let p of confettiParticles){
    p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.rotSpeed;
    confettiCtx.save();
    confettiCtx.translate(p.x,p.y);
    confettiCtx.rotate(p.rot * Math.PI/180);
    confettiCtx.fillStyle = p.color;
    confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
    confettiCtx.restore();
  }
  confettiParticles = confettiParticles.filter(p=>p.y < confettiCanvas.height+50);
  if(confettiParticles.length>0) confettiFrameId = requestAnimationFrame(confettiFrame);
  else { confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); cancelAnimationFrame(confettiFrameId); confettiFrameId = null; }
}

/* ====== TTS (same as before, try to pick voice) ====== */
function speak(text, langPref){
  if(!window.speechSynthesis) return;
  const utter = new SpeechSynthesisUtterance(text);
  const voices = window.speechSynthesis.getVoices();
  let voice = null;
  if(langPref === 'en'){
    voice = voices.find(v=>/en-?/.test(v.lang)) || voices.find(v=>v.lang.startsWith('en')) || null;
    utter.lang = voice ? voice.lang : 'en-US';
  } else if(langPref === 'ar'){
    voice = voices.find(v=>/ar-?/.test(v.lang)) || voices.find(v=>v.lang.startsWith('ar')) || null;
    utter.lang = voice ? voice.lang : 'ar-SA';
  }
  if(voice) utter.voice = voice;
  utter.rate = 0.95; utter.pitch = 1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

/* ====== file parsing ====== */
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    const raw = ev.target.result;
    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const parsed = lines.map(line=>{
      let sep = null;
      if(line.includes('=')) sep='=';
      else if(line.includes('-')) sep='-';
      else sep=' ';
      const parts = line.split(sep).map(p=>p.trim()).filter(Boolean);
      if(parts.length>=2) return {en:parts[0], ar:parts.slice(1).join(' ')};
      const p2 = line.split(/\s+/);
      if(p2.length>=2) return {en:p2[0], ar:p2.slice(1).join(' ')};
      return null;
    }).filter(Boolean);
    if(parsed.length===0){ alert('لم يتم العثور على كلمات صالحة في الملف'); return; }
    originalWords = parsed;
    alert(`تم تحميل ${originalWords.length} كلمة ✅`);
    // update localStorage base words (optional)
    saveState(); // save immediate
    showHomeControls();
  };
  reader.readAsText(f, 'UTF-8');
});

/* ====== resume check & welcome behavior ====== */
function loadState(){
  try{
    const s = localStorage.getItem(localKey);
    if(!s) return null;
    const obj = JSON.parse(s);
    return obj;
  }catch(e){ return null; }
}
function saveState(){
  try{
    const obj = {
      originalWords, words, current, mistakes, mode, correctCount, starsEarned, difficulty
    };
    localStorage.setItem(localKey, JSON.stringify(obj));
  }catch(e){}
}
function clearState(){
  try{ localStorage.removeItem(localKey); }catch(e){}
}

/* on load: populate defaults and show resume if available */
originalWords = defaultWords.slice();
updateProgressBar(0, originalWords.length);

if(resumeAvailable){
  resumeArea.style.display='block';
  resumeBtn.addEventListener('click', ()=> {
    const s = loadState();
    if(!s) return;
    originalWords = s.originalWords && s.originalWords.length ? s.originalWords : defaultWords.slice();
    words = s.words || [];
    current = s.current || 0;
    mistakes = s.mistakes || [];
    mode = s.mode || null;
    correctCount = s.correctCount || 0;
    starsEarned = s.starsEarned || 0;
    difficulty = s.difficulty || 'medium';
    // show directly mode selection or resume into quiz
    if(mode){
      // resume quiz
      welcome.classList.add('hidden');
      setTimeout(()=> welcome.style.display='none',450);
      showQuizDirectly();
    } else {
      // move to modes
      welcome.classList.add('hidden');
      setTimeout(()=> welcome.style.display='none',450);
      setTimeout(()=> { modesSection.style.display='flex'; },500);
    }
  });
}

/* difficulty buttons on welcome */
beginDiffButtons.forEach(btn=>{
  if(!btn.dataset.diff) return;
  btn.addEventListener('click', ()=>{
    difficulty = btn.dataset.diff;
    // highlight selection visually
    beginDiffButtons.forEach(b=>b.style.borderColor='rgba(37,99,235,0.12)');
    btn.style.borderColor = 'var(--accent)';
  });
});

/* welcome begin */
beginBtn.addEventListener('click', ()=>{
  showHomeControls();
  welcome.classList.add('hidden');
  setTimeout(()=> welcome.style.display='none',450);
});

/* show home controls */
function showHomeControls(){
  document.getElementById('hearts').style.display='flex';
  document.getElementById('icon-book').style.display='block';
  document.getElementById('subtitle').style.display='block';
  document.getElementById('divider').style.display='block';
  document.getElementById('main-title').style.display='block';
  homeControls.style.display='flex';
  modesSection.style.display='none';
  quizBlock.style.display='none';
  reviewBlock.style.display='none';
  feedbackEl.innerText = '';
  updateProgressBar(0, originalWords.length);
}

/* ====== start buttons from home ====== */
startBtn.addEventListener('click', ()=>{
  if(!originalWords || originalWords.length===0) originalWords = defaultWords.slice();
  document.getElementById('hearts').style.display='none';
  document.getElementById('icon-book').style.display='none';
  document.getElementById('subtitle').style.display='none';
  document.getElementById('divider').style.display='none';
  document.getElementById('main-title').style.display='none';
  homeControls.style.display='none';
  modesSection.style.display='flex';
});

/* mode start */
startMC.addEventListener('click', ()=>{
  mode = 'mc';
  beginRound(pickWordsByDifficulty());
});
startType.addEventListener('click', ()=>{
  mode = 'type';
  beginRound(pickWordsByDifficulty());
});
function pickWordsByDifficulty(){
  let list = originalWords.slice();
  if(difficulty === 'easy') list = shuffle(list).slice(0, Math.min(10, list.length));
  else if(difficulty === 'medium') list = shuffle(list).slice(0, Math.min(20, list.length));
  else list = list.slice();
  return list;
}

/* begin round */
function beginRound(list){
  words = list.slice();
  current = 0;
  mistakes = [];
  feedbackEl.innerText = '';
  modesSection.style.display='none';
  reviewBlock.style.display='none';
  finalMsg.style.display='none';
  quizBlock.style.display='block';
  typeArea.style.display = (mode==='type') ? 'block' : 'none';
  optionsEl.innerHTML = '';
  correctCount = 0;
  starsEarned = 0;
  updateStars();
  updateProgressBar(current, words.length);
  showQuestion();
  saveState();
}

/* direct resume into quiz (if saved had mode) */
function showQuizDirectly(){
  quizBlock.style.display='block';
  typeArea.style.display = (mode==='type') ? 'block' : 'none';
  updateStars();
  updateProgressBar(current, words.length || originalWords.length);
  showQuestion();
}

/* progress */
function updateProgressBar(idx, total){
  const tot = total || (originalWords.length || 1);
  const cur = Math.min(idx+1, tot);
  progressText.innerText = `${cur}/${tot} سؤال`;
  const pct = Math.round((idx / Math.max(1, tot)) * 100);
  progressBar.style.width = pct + '%';
}

/* showQuestion */
function showQuestion(){
  if(current >= words.length){
    quizBlock.style.display = 'none';
    showReview();
    return;
  }
  updateProgressBar(current, words.length);
  const q = words[current];
  if(mode === 'mc'){
    const ask = q.en;
    questionText.innerText = `Question: "${ask}"`;
    let opts = [q.ar];
    while(opts.length < 4){
      const pick = originalWords[Math.floor(Math.random()*originalWords.length)].ar;
      if(!opts.includes(pick)) opts.push(pick);
    }
    opts = shuffle(opts);
    optionsEl.innerHTML = '';
    opts.forEach(opt=>{
      const el = document.createElement('div');
      el.className = 'option';
      el.textContent = opt;
      el.addEventListener('click', ()=> handleMCChoice(el, opt, q));
      optionsEl.appendChild(el);
    });
    typeArea.style.display='none';
    typeInput.value = '';
    typeInput.blur();
    // speak english
    speak(ask,'en');
    animateQuestionIn();
  } else if(mode === 'type'){
    questionText.innerText = q.ar;
    optionsEl.innerHTML = '';
    typeArea.style.display='block';
    typeInput.value = '';
    typeInput.focus();
    speak(q.ar,'ar');
    animateQuestionIn();
  }
  saveState();
}

/* question animation */
function animateQuestionIn(){
  questionEl.style.transform = 'translateY(-6px)';
  setTimeout(()=> questionEl.style.transform = 'translateY(0)',220);
}

/* play question */
speakQuestionBtn.addEventListener('click', ()=>{
  const q = words[current];
  if(!q) return;
  if(mode === 'mc') speak(q.en,'en'); else speak(q.ar,'ar');
});

/* MC handler */
function handleMCChoice(el, chosen, q){
  const options = Array.from(document.querySelectorAll('.option'));
  options.forEach(o => o.style.pointerEvents='none');
  if(chosen === q.ar){
    el.classList.add('correct');
    feedbackEl.innerText = msgsCorrect[Math.floor(Math.random()*msgsCorrect.length)];
    playCorrect();
    correctCount++;
    checkForStar();
  } else {
    el.classList.add('wrong');
    options.forEach(o => { if(o.textContent === q.ar) o.classList.add('correct'); });
    feedbackEl.innerText = msgsWrong[Math.floor(Math.random()*msgsWrong.length)];
    playWrong();
    mistakes.push(q);
  }
  // speak correct arabic for reinforcement
  setTimeout(()=>{
    if(chosen !== q.ar) speak(q.ar,'ar');
    current++;
    feedbackEl.innerText = '';
    showQuestion();
  },900);
}

/* typing handler */
typeInput.addEventListener('keydown', function(e){
  if(e.key === 'Enter'){
    e.preventDefault();
    const val = typeInput.value.trim();
    if(val === '') return;
    handleTyping(val);
  }
});
function handleTyping(val){
  const q = words[current];
  const correct = q.en.trim().toLowerCase();
  const given = val.trim().toLowerCase();
  if(given === correct){
    feedbackEl.innerText = msgsCorrect[Math.floor(Math.random()*msgsCorrect.length)];
    playCorrect();
    speak(q.en,'en');
    correctCount++;
    checkForStar();
  } else {
    feedbackEl.innerText = msgsWrong[Math.floor(Math.random()*msgsWrong.length)];
    playWrong();
    speak(q.en,'en');
    mistakes.push(q);
  }
  typeInput.blur();
  setTimeout(()=>{
    current++;
    feedbackEl.innerText = '';
    showQuestion();
  },900);
}

/* check for stars (every 5 correct) */
function checkForStar(){
  const newStars = Math.floor(correctCount / 5);
  if(newStars > starsEarned){
    const gained = newStars - starsEarned;
    starsEarned = newStars;
    // animate next star(s)
    for(let i=0;i<gained;i++){
      const idx = Math.min(starEls.length-1, starsEarned-1-i);
      if(starEls[idx]) {
        starEls[idx].classList.add('active');
        // small pulse
        starEls[idx].style.transform = 'scale(1.2)';
        setTimeout(()=> starEls[idx].style.transform = 'scale(1)',300);
      }
    }
    // confetti
    spawnConfetti(60);
  }
  updateStars();
  saveState();
}
function updateStars(){
  for(let i=0;i<starEls.length;i++){
    if(i < starsEarned) starEls[i].classList.add('active'); else starEls[i].classList.remove('active');
  }
}

/* review / retry / home */
function showReview(){
  reviewBlock.style.display = 'block';
  const unique = dedupeKeepOrder(mistakes);
  if(unique.length === 0){
    reviewList.innerHTML = `<div class="review-item" style="justify-content:center">برافو! مفيش ولا غلطة 👏❤️</div>`;
    finalMsg.style.display = 'block';
    // show secret button when final visible
    showSecretButton();
    // confetti / celebration
    spawnConfetti(120);
  } else {
    reviewList.innerHTML = unique.map(u => 
      `<div class="review-item">
         <div style="text-align:right">${u.en} → <span class="mean">${u.ar}</span></div>
         <div>
           <button class="play-icon" data-lang="en" data-en="${u.en}" title="اسمع الانجليزي">🔊</button>
           <button class="play-icon" data-lang="ar" data-ar="${u.ar}" title="اسمع العربي">🔈</button>
         </div>
       </div>`
    ).join('');
    finalMsg.style.display = 'none';
  }
  retryBtn.style.display = unique.length > 0 ? 'inline-block' : 'none';
  // attach play handlers
  document.querySelectorAll('.play-icon').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const lang = btn.getAttribute('data-lang');
      if(lang === 'en') speak(btn.getAttribute('data-en'),'en');
      else speak(btn.getAttribute('data-ar'),'ar');
    });
  });
  saveState();
}

/* retry logic */
retryBtn.addEventListener('click', ()=>{
  const unique = dedupeKeepOrder(mistakes);
  if(unique.length === 0){ alert('مفيش كلمات غلط 🎉'); return; }
  words = unique.slice();
  mistakes = [];
  current = 0;
  quizBlock.style.display='block';
  reviewBlock.style.display='none';
  feedbackEl.innerText = '';
  updateProgressBar(current, words.length);
  showQuestion();
});

/* home button returns to initial home screen */
homeBtn.addEventListener('click', resetToHome);
homeBtnFixed.addEventListener('click', resetToHome);
function resetToHome(){
  originalWords = originalWords.length ? originalWords.slice() : defaultWords.slice();
  words = [];
  mistakes = [];
  current = 0;
  mode = null;
  correctCount = 0;
  starsEarned = 0;
  updateStars();
  document.getElementById('hearts').style.display='flex';
  document.getElementById('icon-book').style.display='block';
  document.getElementById('subtitle').style.display='block';
  document.getElementById('divider').style.display='block';
  document.getElementById('main-title').style.display='block';
  homeControls.style.display='flex';
  modesSection.style.display='none';
  quizBlock.style.display='none';
  reviewBlock.style.display='none';
  finalMsg.style.display='none';
  feedbackEl.innerText = '';
  updateProgressBar(0, originalWords.length);
  clearState();
}

/* save button manual */
saveBtn.addEventListener('click', ()=>{
  saveState();
  alert('تم حفظ التقدّم ✅');
});

/* start with keyboard Enter accessibility */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && homeControls.style.display !== 'none'){
    startBtn.click();
  }
});

/* secret button logic */
let secretBtn = null;
function showSecretButton(){
  // create once and append under finalMsg
  if(secretBtn) { secretBtn.style.display = 'inline-block'; return; }
  secretBtn = document.createElement('button');
  secretBtn.textContent = '💌 من معاذ';
  secretBtn.style.cssText = `display:inline-block; margin-top:10px; padding:10px 16px; border:none; border-radius:10px; background:linear-gradient(90deg,#3b82f6,#06b6d4); color:white; font-weight:800; cursor:pointer;`;
  finalMsg.after(secretBtn);
  secretBtn.addEventListener('click', ()=>{
    secretMessage.style.display = 'block';
    secretMessage.setAttribute('aria-hidden','false');
    // optionally auto-hide after 6 seconds
    setTimeout(()=> { secretMessage.style.display='none'; secretMessage.setAttribute('aria-hidden','true'); }, 6000);
  });
  // create also a close
  secretClose.addEventListener('click', ()=> {
    secretMessage.style.display='none';
    secretMessage.setAttribute('aria-hidden','true');
  });
}

/* allow keyboard shortcut for secret (Konami-style) - optional (not required but nice)
   For simplicity: if user types "moaz" on keyboard, show secret (case-insensitive)
*/
let keyBuffer = '';
window.addEventListener('keydown', e=>{
  keyBuffer += e.key.toLowerCase();
  if(keyBuffer.length > 10) keyBuffer = keyBuffer.slice(-10);
  if(keyBuffer.includes('moaz') || keyBuffer.includes('معاذ')) {
    secretMessage.style.display = 'block';
    secretMessage.setAttribute('aria-hidden','false');
    setTimeout(()=> { secretMessage.style.display='none'; secretMessage.setAttribute('aria-hidden','true'); }, 5000);
    keyBuffer = '';
  }
});

/* init: default words until user uploads */
originalWords = defaultWords.slice();
updateProgressBar(0, originalWords.length);

/* voices */
if(window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = ()=>{} }

/* helper to show review when done is already in showQuestion */

/* ensure everything saved on unload */
window.addEventListener('beforeunload', ()=> { saveState(); });

/* small helper to show modes from welcome if want (not necessary but safe) */
document.querySelectorAll('.mode-start').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    // nothing extra here; handled above
  });
});

</script>
</body>
</html>

<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø£Ø´Ø·Ø± Ø¨Ù†ÙˆØªÙ‡ Ù Ø§Ù„Ø¯Ù†ÙŠØ§ â¤ï¸ â€” Ù„ÙŠÙ†Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* Ù…ÙŠÙƒØ³ Ø£Ù„ÙˆØ§Ù†: Ø£Ø²Ø±Ù‚ - Ø£Ø¨ÙŠØ¶ - Ø¨Ù†ÙØ³Ø¬ÙŠ */
    --bg-top: #eef6ff;
    --bg-bottom: #ffffff;
    --primary: #2563eb;
    --accent: linear-gradient(90deg,#3b82f6,#7c3aed);
    --accent-solid: #3b82f6;
    --muted:#64748b;
    --success:#16a34a;
    --danger:#ef4444;
    --card-bg: rgba(255,255,255,0.98);
    --text:#0f172a;
    --pink:#ec4899;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Cairo",sans-serif}
  html,body{height:100%}
  body{
    background: linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* layout */
  .stage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
  .card{
    width:100%;max-width:980px;border-radius:18px;background:var(--card-bg);
    box-shadow:0 30px 70px rgba(15,23,42,0.08);padding:28px;position:relative;overflow:hidden;
    display:grid;grid-template-columns:1fr 420px;gap:22px;align-items:start;
  }

  /* left column (main) */
  .main-area{padding:6px}
  h1.title{margin:6px 0 12px;font-size:36px;color:var(--primary);font-weight:800}
  .divider{height:8px;width:180px;margin:12px 0;border-radius:8px;background:linear-gradient(90deg,#60a5fa,#a78bfa)}
  .subtitle{margin:6px 0 18px;color:rgba(15,23,42,0.6);font-size:15px}

  .hearts-row{display:flex;gap:10px;align-items:center}
  .hearts-row span{font-size:20px;color:rgba(59,130,246,0.7)}

  /* controls */
  .controls{display:flex;flex-direction:column;gap:12px;align-items:flex-start}
  .primary-btn{
    padding:14px 18px;border-radius:12px;border:none;
    background:linear-gradient(90deg,#3b82f6,#7c3aed); color:white; font-size:18px;font-weight:800;
    cursor:pointer; box-shadow:0 14px 36px rgba(59,130,246,0.12);
  }
  .file-btn{
    padding:12px;border-radius:12px;border:1px solid rgba(37,99,235,0.12);background:transparent;color:var(--text);font-weight:700;cursor:pointer;font-size:16px;
  }
  .resume-banner{background:linear-gradient(90deg,#fef3c7,#fef08a); padding:8px 12px; border-radius:12px; font-weight:700; color:#92400e; display:inline-flex; gap:10px; align-items:center}

  /* right column (compact card) */
  .side{background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.98));border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.04)}
  .mode-card{background:rgba(255,255,255,0.96);padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04)}
  .mode-card .mode-title{font-weight:800;margin-bottom:6px}
  .mode-start{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,#3b82f6,#7c3aed);color:#fff;font-weight:800;cursor:pointer}

  /* quiz area */
  .quiz{margin-top:12px;display:none}
  #progressBarContainer{width:100%;background:#eef2ff;height:34px;border-radius:999px;overflow:hidden;position:relative;margin-bottom:12px}
  #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#3b82f6,#60a5fa);transition:width .4s ease}
  #progressText{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;text-shadow:0 1px 2px rgba(0,0,0,0.2)}

  #question{font-size:18px;margin:12px 0;padding:14px;border-radius:12px;background:rgba(2,6,23,0.03);min-height:68px;display:flex;align-items:center;justify-content:center;gap:10px}
  .speak-btn{background:transparent;border:none;font-size:20px;cursor:pointer;color:var(--primary)}
  .options{display:flex;flex-direction:column;gap:12px;align-items:center;margin-bottom:12px}
  .option{width:88%;max-width:520px;padding:12px 16px;border-radius:12px;background:#3b82f6;color:white;font-weight:800;cursor:pointer;box-shadow:0 12px 34px rgba(59,130,246,0.12);transition:transform .12s}
  .option:hover{transform:translateY(-3px)}
  .option.correct{background:var(--success) !important}
  .option.wrong{background:var(--danger) !important}

  .type-input{width:80%;max-width:520px;padding:12px;border-radius:10px;border:2px solid rgba(37,99,235,0.12);text-align:center;font-weight:800;font-size:16px}
  #feedback{margin-top:10px;font-weight:800;min-height:28px}

  /* stars area */
  .stars-wrap{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:12px}
  .star{font-size:28px; opacity:0.25; transition:transform .25s, opacity .25s}
  .star.active{opacity:1; transform:scale(1.12)}

  /* review */
  .review{display:none;margin-top:18px}
  .review-list{max-height:360px;overflow:auto;margin:12px auto;width:92%;max-width:760px;text-align:right}
  .review-item{display:flex;justify-content:space-between;align-items:center;background:#f0f9f1;color:var(--success);font-size:18px;font-weight:900;padding:12px 14px;border-radius:10px;margin:8px 0}
  .review-item .mean{color:var(--text);font-size:16px;font-weight:700;opacity:0.95;margin-left:10px}
  .play-icon{background:transparent;border:none;font-size:18px;color:var(--primary);cursor:pointer;margin-left:8px}

  .review-controls{display:flex;gap:12px;justify-content:center;margin-top:12px}
  .btn-ghost{padding:10px 14px;border-radius:10px;border:1px solid rgba(37,99,235,0.12);background:transparent;cursor:pointer;font-weight:700}
  .btn-home{padding:12px 16px;border-radius:12px;border:none;background:#64748b;color:white;font-weight:800;cursor:pointer}

  .final-msg{display:none;margin-top:16px;font-size:20px;color:var(--primary);font-weight:900}
  .note{margin-top:14px;color:rgba(15,23,42,0.6);font-size:13px}

  /* confetti canvas */
  #confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9998}

  /* secret and popup */
  #secretBtn{position:fixed;bottom:22px;right:22px;background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;font-weight:800;border:none;border-radius:50px;padding:12px 18px;font-size:14px;box-shadow:0 8px 20px rgba(99,102,241,0.3);cursor:pointer;display:none;z-index:10001;transition:all .3s ease}
  #lovePopup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#ffffff,#e9efff);border:2px solid #a78bfa;border-radius:16px;box-shadow:0 8px 40px rgba(37,99,235,0.15);padding:22px;width:340px;text-align:center;display:none;z-index:10002}
  #lovePopup h3{color:#2563eb;font-size:20px;margin-bottom:10px}
  #lovePopup p{color:#0f172a;font-size:16px;font-weight:800}
  #closePopup{margin-top:12px;background:linear-gradient(90deg,#6366f1,#3b82f6);color:#fff;border:none;padding:8px 14px;border-radius:12px;cursor:pointer;font-weight:800}

  /* hearts bg for animation */
  .hearts-bg{position:fixed;inset:0;overflow:hidden;z-index:0;pointer-events:none}
  .heart{position:absolute;animation:float 8s linear infinite;opacity:0.2}
  @keyframes float { 0% {transform:translateY(110vh) scale(.8);} 50%{opacity:1} 100%{transform:translateY(-10vh) scale(1.2);opacity:0} }

  @media (max-width:980px){
    .card{grid-template-columns:1fr;max-width:480px;padding:20px}
    .side{order:2}
  }
</style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="hearts-bg" id="hearts-bg" aria-hidden="true"></div>

  <div class="stage">
    <main class="card" role="main" aria-labelledby="main-title">
      <div class="main-area">
        <div class="hearts-row" aria-hidden="true"><span>â¤</span><span>â¤</span><span style="opacity:.7">â¤</span></div>
        <h1 id="main-title" class="title">Ø£Ø´Ø·Ø± Ø¨Ù†ÙˆØªÙ‡ Ù Ø§Ù„Ø¯Ù†ÙŠØ§ â¤ï¸</h1>
        <div class="divider" id="divider" aria-hidden="true"></div>
        <p class="subtitle" id="subtitle">Ready to learn some English?</p>

        <!-- HOME controls -->
        <div class="controls" id="homeControls" aria-label="home controls">
          <div id="resumeArea" style="display:none" class="resume-banner">ÙŠÙˆØ¬Ø¯ Ø­ÙØ¸ Ø³Ø§Ø¨Ù‚ â€” <button id="resumeBtn" class="btn-ghost">Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØª</button></div>
          <button id="startBtn" class="primary-btn" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
          <label class="file-btn" for="fileInput" title="Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø®Ø§ØµØ©">
            Ø±ÙØ¹ ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ© ğŸ“
            <input id="fileInput" type="file" accept=".txt" style="display:none" aria-label="Ø§Ø®ØªØ± Ù…Ù„Ù txt" />
          </label>
          <div class="note">Ø§Ø±ÙØ¹ Ù…Ù„Ù .txt Ø¨ØµÙŠØºØ©: <em>book=ÙƒØªØ§Ø¨</em> Ø£Ùˆ <em>book ÙƒØªØ§Ø¨</em> Ø£Ùˆ <em>book-ÙƒØªØ§Ø¨</em>. Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† UTF-8 Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø¹Ø±Ø¨ÙŠ.</div>
        </div>

        <!-- modes will be shown after start -->
        <section class="modes" id="modesSection" aria-label="Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±" style="display:none">
          <div class="mode-card mc" role="article">
            <div class="mode-title">Multiple Choice â€” Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</div>
            <div class="mode-desc">See an English word and choose the correct Arabic meaning from 4 options</div>
            <button class="mode-start" id="startMC">Ø§Ø¨Ø¯Ø¦ÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª ğŸ¯</button>
          </div>

          <div class="mode-card type" role="article">
            <div class="mode-title">Type the Word â€” ÙƒØªØ§Ø¨Ø©</div>
            <div class="mode-desc">See the Arabic meaning and type the correct English word</div>
            <button class="mode-start" id="startType">Ø§Ø¨Ø¯Ø¦ÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© âœï¸</button>
          </div>
        </section>

        <!-- quiz block -->
        <section class="quiz" id="quizBlock" aria-live="polite" style="display:none">
          <div id="progressBarContainer"><div id="progressBar"></div><div id="progressText">0/0 Ø³Ø¤Ø§Ù„</div></div>

          <div id="question"><span id="questionText">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</span>
            <button id="speakQuestion" class="speak-btn" title="Ø§Ø³Ù…Ø¹ Ø§Ù„Ù†Ø·Ù‚">ğŸ”Š</button>
          </div>

          <div class="options" id="options"></div>

          <div id="typeArea" style="display:none">
            <input id="typeInput" class="type-input" type="text" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø«Ù… Ø§Ø¶ØºØ·ÙŠ Enter" />
          </div>

          <div id="feedback" aria-live="assertive"></div>

          <div class="stars-wrap" id="starsWrap" title="Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²" style="margin-top:10px">
            <div class="star" id="star1">â­</div>
            <div class="star" id="star2">â­</div>
            <div class="star" id="star3">â­</div>
            <div class="star" id="star4">â­</div>
            <div class="star" id="star5">â­</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
            <button id="saveBtn" class="btn-ghost">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</button>
            <button id="homeBtnFixed" class="btn-home">ğŸ  Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
          </div>
        </section>

        <!-- review -->
        <section class="review" id="reviewBlock" aria-live="polite" style="display:none">
          <h3>Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„ÙŠ ØºÙ„Ø·ØªÙŠ ÙÙŠÙ‡Ø§ ğŸ“˜</h3>
          <div class="review-list" id="reviewList"></div>
          <div class="review-controls">
            <button id="retryBtn" class="primary-btn" style="display:none">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØºÙ„Ø·</button>
            <button id="homeBtn" class="btn-home">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
          </div>
          <div class="final-msg" id="finalMsg" style="display:none">ÙˆØ§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ùˆ ğŸ˜ Ø´Ø·ÙˆØ±Ø© Ø£ÙˆÙŠ Ø£ÙˆÙŠ ÙˆØ§Ù„Ù„Ù‡ â¤ï¸</div>
        </section>
      </div>

      <!-- side (compact) -->
      <aside class="side" aria-hidden="false">
        <div style="text-align:center;margin-bottom:12px">
          <div style="font-weight:800;color:var(--muted);margin-bottom:8px">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ / Ø§Ø¨Ø¯Ø¦ÙŠ</div>
          <div style="color:var(--muted);font-size:13px">Ø§Ù„Ù„ÙˆÙ†: Ù…Ø²ÙŠØ¬ Ø£Ø²Ø±Ù‚-Ø£Ø¨ÙŠØ¶-Ø¨Ù†ÙØ³Ø¬ÙŠ (Ø¹ØµØ±ÙŠ)</div>
        </div>

        <div style="margin-bottom:12px">
          <div style="font-weight:800;color:var(--muted);margin-bottom:6px">Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸</div>
          <div id="saveStatus" style="font-size:14px;color:var(--muted)">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯</div>
        </div>

        <div style="margin-top:8px">
          <div style="font-weight:800;color:var(--muted);margin-bottom:6px">Ù…Ø³Ø§Ø¹Ø¯Ø©</div>
          <div style="font-size:13px;color:var(--muted)">Ø§Ø¯Ø®Ù„ÙŠ Ù…Ù„Ù ÙƒÙ„Ù…Ø§Øª Ø«Ù… Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆØ¶Ø¹ â€” Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø£Ùˆ Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
        </div>
      </aside>

    </main>
  </div>

  <!-- secret button & love popup -->
  <button id="secretBtn" aria-hidden="true">ğŸ’Œ Ù…Ù† Ø²ÙˆØ²Ùˆ</button>
  <div id="lovePopup" role="dialog" aria-hidden="true">
    <h3>Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø²ÙˆØ²Ùˆ ğŸ’–</h3>
    <p id="loveText">Ø¨Ø­Ø¨ÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒ ÙˆØ§Ù„Ù„Ù‡ ğŸ’–</p>
    <button id="closePopup">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>

<script>
/* ======= JS: ÙƒØ§Ù…Ù„ ÙˆÙ…Ø±ÙƒÙ‘Ø² Ø¯Ø§Ø®Ù„ DOMContentLoaded ======= */
document.addEventListener('DOMContentLoaded', () => {

  /* ===== elements ===== */
  const fileInput = document.getElementById('fileInput');
  const startBtn = document.getElementById('startBtn');
  const homeControls = document.getElementById('homeControls');
  const modesSection = document.getElementById('modesSection');
  const startMC = document.getElementById('startMC');
  const startType = document.getElementById('startType');
  const quizBlock = document.getElementById('quizBlock');
  const questionText = document.getElementById('questionText');
  const optionsEl = document.getElementById('options');
  const typeArea = document.getElementById('typeArea');
  const typeInput = document.getElementById('typeInput');
  const feedbackEl = document.getElementById('feedback');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const reviewBlock = document.getElementById('reviewBlock');
  const reviewList = document.getElementById('reviewList');
  const retryBtn = document.getElementById('retryBtn');
  const homeBtn = document.getElementById('homeBtn');
  const homeBtnFixed = document.getElementById('homeBtnFixed');
  const saveBtn = document.getElementById('saveBtn');
  const resumeArea = document.getElementById('resumeArea');
  const resumeBtn = document.getElementById('resumeBtn');
  const saveStatus = document.getElementById('saveStatus');
  const speakBtn = document.getElementById('speakQuestion');

  const secretBtn = document.getElementById('secretBtn');
  const lovePopup = document.getElementById('lovePopup');
  const loveText = document.getElementById('loveText');
  const closePopup = document.getElementById('closePopup');

  const confettiCanvas = document.getElementById('confetti');
  const confettiCtx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;

  const starEls = [
    document.getElementById('star1'),
    document.getElementById('star2'),
    document.getElementById('star3'),
    document.getElementById('star4'),
    document.getElementById('star5')
  ];

  /* ===== state ===== */
  const localKey = 'lina_quiz_v1_state';
  let originalWords = [];
  let words = [];
  let current = 0;
  let mistakes = [];
  let mode = null; // "mc" or "type"
  let correctCount = 0;
  let starsEarned = 0;

  /* ===== messages (preserved) ===== */
  const msgsCorrect = ["Ø£Ø´Ø·Ø± Ù„ÙŠÙ†Ø§ â¤ï¸","Ø´Ø·ÙˆØ±Ù‡ ÙŠØ§ Ø¨Ø·ØªÙŠ â¤ï¸","Ø´Ø·ÙˆØ±Ù‡ ÙŠØ§ Ù‚Ø·ØªÙŠ â¤ï¸","Ø§ÙŠÙ‡ Ø§Ù„Ø´Ø·Ø§Ø±Ø© Ø¯ÙŠ ÙŠØ§ Ù…Ø²ØªÙŠ â¤ï¸","Ø´Ø·ÙˆÙˆÙˆÙˆÙˆÙˆØ±Ø© ÙŠØ§ Ù…Ø²ØªÙŠ â¤ï¸","Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ ğŸ˜","Ø®Ø¯ÙŠ Ø¨ÙˆØ³Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø·Ø§Ø±Ø© Ø¯ÙŠ ğŸ˜˜"];
  const msgsWrong = ["Ù†Ø±ÙƒØ² ÙŠØ§ Ù‚Ø·ØªÙŠ â¤ï¸","ÙÙŠÙ‡ Ø§Ø­Ø³Ù† ÙŠØ§ Ù…Ø²Ù‡ â¤ï¸","Ø¹Ø§Ø¯ÙŠ ÙŠØ§ Ø­Ø¨ÙŠØ¨ÙŠ Ù†Ø­ÙØ¸ ØªØ§Ù†ÙŠ â¤ï¸","Ø¹Ø§Ø¯ÙŠ ÙŠØ§ Ù…Ø²ØªÙŠ Ù†Ø°Ø§ÙƒØ± ØªØ§Ù†ÙŠ ğŸ’ª","ÙÙŠÙ‡ Ø£Ø­Ø³Ù† ÙŠØ§ Ù‚Ø·ØªÙŠ ğŸ©µ"];

  /* ===== default words (full list from your earlier code) ===== */
  const defaultWords = [
    { en: "duty", ar: "ÙˆØ§Ø¬Ø¨ - ÙˆØ¸ÙŠÙØ©" },
    { en: "emergency", ar: "Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦" },
    { en: "flood", ar: "ÙŠØºÙ…Ø± - ÙÙŠØ¶Ø§Ù†" },
    { en: "obligation", ar: "Ø§Ù„ØªØ²Ø§Ù… - ÙˆØ§Ø¬Ø¨" },
    { en: "protect", ar: "ÙŠØ­Ù…ÙŠ - ÙŠØ­Ø§ÙØ¸" },
    { en: "rescue", ar: "ÙŠÙ†Ù‚Ø°" },
    { en: "risk", ar: "ÙŠØªØ®Ø° Ù…Ø®Ø§Ø·Ø±Ø©" },
    { en: "risky", ar: "Ø®Ø·ÙŠØ± - Ù…Ø­ÙÙˆÙ Ø¨Ø§Ù„Ù…Ø®Ø§Ø·Ø±" },
    { en: "truth", ar: "Ø­Ù‚ÙŠÙ‚Ø©" },
    { en: "accident", ar: "Ø­Ø§Ø¯Ø«" },
    { en: "act", ar: "ÙŠÙØ¹Ù„ - ÙŠØªØµØ±Ù" },
    { en: "aspect", ar: "Ø¬Ø§Ù†Ø¨" },
    { en: "believe in", ar: "ÙŠØ¤Ù…Ù† Ø¨Ù€" },
    { en: "breathe", ar: "ÙŠØªÙ†ÙØ³" },
    { en: "crowded", ar: "Ù…Ø²Ø¯Ø­Ù…" },
    { en: "damp", ar: "Ø±Ø·Ø¨" },
    { en: "debate", ar: "Ù†Ù‚Ø§Ø´" },
    { en: "descriptive", ar: "ÙˆØµÙÙ‰" },
    { en: "drown", ar: "ÙŠØºØ±Ù‚" },
    { en: "fear", ar: "Ø®ÙˆÙ" },
    { en: "fire", ar: "Ù†Ø§Ø± - Ø­Ø±ÙŠÙ‚" },
    { en: "firefighter", ar: "Ø±Ø¬Ù„ Ø¥Ø·ÙØ§Ø¡" },
    { en: "forever", ar: "Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¯" },
    { en: "hope", ar: "Ø£Ù…Ù„" },
    { en: "injured", ar: "Ù…ØµØ§Ø¨" },
    { en: "ladder", ar: "Ø³Ù„Ù…" },
    { en: "lifeguard", ar: "Ù…Ù†Ù‚Ø°" },
    { en: "moss", ar: "Ø·Ø­Ø§Ù„Ø¨" },
    { en: "overall", ar: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø¹Ø§Ù…" },
    { en: "pine needle", ar: "Ø¥Ø¨Ø±Ø© Ø§Ù„ØµÙ†ÙˆØ¨Ø±" },
    { en: "put out", ar: "ÙŠØ·ÙØ¦" },
    { en: "rustling", ar: "Ø®ÙÙŠÙ (Ø£ØµÙˆØ§Øª Ø§Ù„Ø£ÙˆØ±Ø§Ù‚)" },
    { en: "sadly", ar: "Ø¨Ø£Ø³Ù" },
    { en: "save", ar: "ÙŠÙ†Ù‚Ø° - ÙŠØ­ÙØ¸" },
    { en: "scenario", ar: "Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ" },
    { en: "serious", ar: "Ø®Ø·ÙŠØ± - Ø¬Ø§Ø¯" },
    { en: "serve", ar: "ÙŠØ®Ø¯Ù…" },
    { en: "service", ar: "Ø®Ø¯Ù…Ø©" },
    { en: "stand-stood-stood", ar: "ÙŠÙ‚Ù" },
    { en: "storm", ar: "Ø¹Ø§ØµÙØ©" },
    { en: "summarize", ar: "ÙŠÙ„Ø®Øµ" },
    { en: "texture", ar: "Ù†Ø³ÙŠØ¬ - Ù‚ÙˆØ§Ù…" },
    { en: "training", ar: "ØªØ¯Ø±ÙŠØ¨" },
    { en: "trap", ar: "ÙŠØ­Ø¨Ø³ - ÙŠØ®Ø¯Ø¹" },
    { en: "voluntary", ar: "ØªØ·ÙˆØ¹ÙŠ" },
    { en: "worth", ar: "ÙŠØ³ØªØ­Ù‚" },
    { en: "yet", ar: "Ù…Ø§ Ø²Ø§Ù„ - Ø¨Ø¹Ø¯" }
  ];

  /* ===== utilities ===== */
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
  function dedupeKeepOrder(arr){ const seen=new Set(); const out=[]; arr.forEach(it=>{ if(!it) return; const key=`${it.en}|||${it.ar}`; if(!seen.has(key)){ seen.add(key); out.push(it); }}); return out; }
  function randomFrom(list){ return list[Math.floor(Math.random()*list.length)]; }

  /* ===== TTS ===== */
  function speak(text, langPref){
    if(!window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    let voice = null;
    if(langPref === 'en'){
      voice = voices.find(v=>/en-?/.test(v.lang)) || voices.find(v=>v.lang.startsWith('en')) || null;
      utter.lang = voice ? voice.lang : 'en-US';
    } else {
      voice = voices.find(v=>/ar-?/.test(v.lang)) || voices.find(v=>v.lang.startsWith('ar')) || null;
      utter.lang = voice ? voice.lang : 'ar-SA';
    }
    if(voice) utter.voice = voice;
    utter.rate = 0.95; utter.pitch = 1;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
  }

  /* ===== audio tones (small) ===== */
  const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
  function playTone(freq, type='sine', duration=0.12, gain=0.08){
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + duration);
  }
  function playCorrect(){ playTone(880,'sine',0.08,0.06); setTimeout(()=>playTone(1100,'sine',0.08,0.04),70); }
  function playWrong(){ playTone(220,'sawtooth',0.16,0.12); }

  /* ===== confetti ===== */
  let confettiParticles = [];
  function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();
  function spawnConfetti(amount=40){
    if(!confettiCtx) return;
    confettiParticles = [];
    for(let i=0;i<amount;i++){
      confettiParticles.push({
        x: Math.random()*confettiCanvas.width,
        y: Math.random()*confettiCanvas.height - confettiCanvas.height/2,
        vx: (Math.random()-0.5)*8,
        vy: Math.random()*6+2,
        size: Math.random()*8+6,
        color: `hsl(${Math.random()*360} 75% 60%)`,
        rot: Math.random()*360,
        rotSpeed: (Math.random()-0.5)*10
      });
    }
    requestAnimationFrame(confettiFrame);
  }
  let confettiFrameId = null;
  function confettiFrame(){
    if(!confettiCtx) return;
    confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for(let p of confettiParticles){
      p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.rot += p.rotSpeed;
      confettiCtx.save();
      confettiCtx.translate(p.x,p.y);
      confettiCtx.rotate(p.rot * Math.PI/180);
      confettiCtx.fillStyle = p.color;
      confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
      confettiCtx.restore();
    }
    confettiParticles = confettiParticles.filter(p=>p.y < confettiCanvas.height+50);
    if(confettiParticles.length>0) confettiFrameId = requestAnimationFrame(confettiFrame);
    else { if(confettiFrameId) cancelAnimationFrame(confettiFrameId); confettiFrameId = null; confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); }
  }

  /* ===== save/load state ===== */
  function saveState(){
    try{
      const obj = { originalWords, words, current, mistakes, mode, correctCount, starsEarned };
      localStorage.setItem(localKey, JSON.stringify(obj));
      saveStatus.innerText = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…';
      setTimeout(()=> saveStatus.innerText = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…', 1200);
    }catch(e){}
  }
  function loadState(){
    try{
      const s = localStorage.getItem(localKey);
      if(!s) return null;
      return JSON.parse(s);
    }catch(e){ return null; }
  }
  function clearState(){ try{ localStorage.removeItem(localKey); saveStatus.innerText = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯'; }catch(e){} }

  /* ===== resume check ===== */
  if(loadState()){
    resumeArea.style.display = 'block';
  }

  resumeBtn && resumeBtn.addEventListener('click', ()=>{
    const s = loadState();
    if(!s) return;
    originalWords = s.originalWords && s.originalWords.length ? s.originalWords : defaultWords.slice();
    words = s.words || [];
    current = s.current || 0;
    mistakes = s.mistakes || [];
    mode = s.mode || null;
    correctCount = s.correctCount || 0;
    starsEarned = s.starsEarned || 0;
    // show quiz or modes depending
    if(mode){
      homeControls.style.display = 'none';
      modesSection.style.display = 'none';
      quizBlock.style.display = 'block';
      typeArea.style.display = (mode === 'type') ? 'block' : 'none';
      updateStars();
      updateProgressBar(current, words.length || originalWords.length);
      showQuestion();
    } else {
      homeControls.style.display = 'none';
      modesSection.style.display = 'flex';
    }
  });

  /* ===== file parsing ===== */
  fileInput.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      const raw = ev.target.result;
      const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const parsed = lines.map(line=>{
        // detect separator: '=' or '-' or space
        let sep = null;
        if(line.includes('=')) sep='=';
        else if(line.includes('-')) sep='-';
        else sep=' ';
        const parts = line.split(sep).map(p=>p.trim()).filter(Boolean);
        if(parts.length>=2) return {en:parts[0], ar:parts.slice(1).join(' ')};
        const p2 = line.split(/\s+/);
        if(p2.length>=2) return {en:p2[0], ar:p2.slice(1).join(' ')};
        return null;
      }).filter(Boolean);
      if(parsed.length===0){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù'); return; }
      originalWords = parsed;
      words = originalWords.slice();
      saveState();
      alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${originalWords.length} ÙƒÙ„Ù…Ø© âœ…`);
      // show home controls enabled
      homeControls.style.display = 'flex';
      saveStatus.innerText = `Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${originalWords.length} ÙƒÙ„Ù…Ø©`;
      setTimeout(()=> saveStatus.innerText = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…', 1200);
    };
    reader.readAsText(f,'UTF-8');
  });

  /* ===== start flow ===== */
  startBtn.addEventListener('click', ()=>{
    // if no file uploaded, use defaults
    if(!originalWords || originalWords.length===0) originalWords = defaultWords.slice();
    homeControls.style.display = 'none';
    modesSection.style.display = 'flex';
  });

  startMC.addEventListener('click', ()=>{ mode = 'mc'; beginRound(pickWords()); });
  startType.addEventListener('click', ()=>{ mode = 'type'; beginRound(pickWords()); });

  function pickWords(){ return originalWords.slice(); }

  /* ===== begin round ===== */
  function beginRound(list){
    words = list.slice();
    current = 0;
    mistakes = [];
    feedbackEl.innerText = '';
    modesSection.style.display = 'none';
    reviewBlock.style.display = 'none';
    quizBlock.style.display = 'block';
    typeArea.style.display = (mode === 'type') ? 'block' : 'none';
    optionsEl.innerHTML = '';
    correctCount = 0;
    starsEarned = 0;
    updateStars();
    updateProgressBar(current, words.length);
    showQuestion();
    saveState();
  }

  function showQuizDirectly(){
    quizBlock.style.display = 'block';
    typeArea.style.display = (mode === 'type') ? 'block' : 'none';
    updateStars();
    updateProgressBar(current, words.length || originalWords.length);
    showQuestion();
  }

  /* ===== progress bar ===== */
  function updateProgressBar(idx, total){
    const tot = total || (originalWords.length || 1);
    const cur = Math.min(idx+1, tot);
    progressText.innerText = `${cur}/${tot} Ø³Ø¤Ø§Ù„`;
    const pct = Math.round((idx / Math.max(1, tot)) * 100);
    progressBar.style.width = pct + '%';
  }

  /* ===== show question ===== */
  function showQuestion(){
    if(current >= words.length){
      quizBlock.style.display = 'none';
      showReview();
      return;
    }
    updateProgressBar(current, words.length);
    const q = words[current];
    if(mode === 'mc'){
      // show English as question and Arabic options
      const ask = q.en;
      questionText.innerText = `Question: "${ask}"`;
      let opts = [q.ar];
      while(opts.length < 4){
        const pick = originalWords[Math.floor(Math.random()*originalWords.length)].ar;
        if(!opts.includes(pick)) opts.push(pick);
      }
      opts = shuffle(opts);
      optionsEl.innerHTML = '';
      opts.forEach(opt=>{
        const el = document.createElement('button');
        el.className = 'option';
        el.textContent = opt;
        el.onclick = ()=> handleMCChoice(el, opt, q);
        optionsEl.appendChild(el);
      });
      typeArea.style.display = 'none';
      typeInput.value = '';
      typeInput.blur();
      speak(ask,'en');
      animateQuestionIn();
    } else if(mode === 'type'){
      // show Arabic and expect english input
      questionText.innerText = q.ar;
      optionsEl.innerHTML = '';
      typeArea.style.display = 'block';
      typeInput.value = '';
      typeInput.focus();
      speak(q.ar,'ar');
      animateQuestionIn();
    }
    saveState();
  }

  function animateQuestionIn(){
    const el = document.getElementById('question');
    if(!el) return;
    el.style.transform = 'translateY(-6px)';
    setTimeout(()=> el.style.transform = 'translateY(0)',220);
  }

  /* ===== speak question button ===== */
  speakBtn.addEventListener('click', ()=>{
    const q = words[current];
    if(!q) return;
    if(mode === 'mc') speak(q.en,'en'); else speak(q.ar,'ar');
  });

  /* ===== MC handler ===== */
  function handleMCChoice(el, chosen, q){
    const options = Array.from(document.querySelectorAll('.option'));
    options.forEach(o => o.style.pointerEvents='none');
    if(chosen === q.ar){
      el.classList.add('correct');
      feedbackEl.innerText = randomFrom(msgsCorrect);
      playCorrect();
      correctCount++;
      checkForStar();
    } else {
      el.classList.add('wrong');
      options.forEach(o => { if(o.textContent === q.ar) o.classList.add('correct'); });
      feedbackEl.innerText = randomFrom(msgsWrong);
      playWrong();
      mistakes.push(q);
    }
    setTimeout(()=>{
      if(chosen !== q.ar) speak(q.ar,'ar');
      current++;
      feedbackEl.innerText = '';
      showQuestion();
    },900);
  }

  /* ===== typing handler ===== */
  typeInput.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      e.preventDefault();
      const val = typeInput.value.trim();
      if(val === '') return;
      handleTyping(val);
    }
  });
  function handleTyping(val){
    const q = words[current];
    const correct = q.en.trim().toLowerCase();
    const given = val.trim().toLowerCase();
    if(given === correct){
      feedbackEl.innerText = randomFrom(msgsCorrect);
      playCorrect();
      speak(q.en,'en');
      correctCount++;
      checkForStar();
    } else {
      feedbackEl.innerText = randomFrom(msgsWrong);
      playWrong();
      speak(q.en,'en');
      mistakes.push(q);
    }
    typeInput.blur();
    setTimeout(()=>{
      current++;
      feedbackEl.innerText = '';
      showQuestion();
    },900);
  }

  /* ===== stars logic ===== */
  function checkForStar(){
    const newStars = Math.floor(correctCount / 5);
    if(newStars > starsEarned){
      const gained = newStars - starsEarned;
      starsEarned = newStars;
      for(let i=0;i<gained;i++){
        const idx = Math.min(starEls.length-1, starsEarned-1-i);
        if(starEls[idx]) {
          starEls[idx].classList.add('active');
          starEls[idx].style.transform = 'scale(1.22)';
          setTimeout(()=> starEls[idx].style.transform = 'scale(1)',300);
        }
      }
      spawnConfetti(60);
    }
    updateStars();
    saveState();
  }
  function updateStars(){
    for(let i=0;i<starEls.length;i++){
      if(i < starsEarned) starEls[i].classList.add('active'); else starEls[i].classList.remove('active');
    }
  }

  /* ===== review / retry / home ===== */
  function showReview(){
    reviewBlock.style.display = 'block';
    const unique = dedupeKeepOrder(mistakes);
    reviewList.innerHTML = '';
    if(unique.length === 0){
      reviewList.innerHTML = `<div class="review-item" style="justify-content:center">Ø¨Ø±Ø§ÙÙˆ! Ù…ÙÙŠØ´ ÙˆÙ„Ø§ ØºÙ„Ø·Ø© ğŸ‘â¤ï¸</div>`;
      finalMsg.style.display = 'block';
      showSecretButton(); // show special button when perfect
      spawnConfetti(120);
    } else {
      unique.forEach(u=>{
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `<div style="text-align:right">${u.en} â†’ <span class="mean">${u.ar}</span></div>
                         <div>
                           <button class="play-icon" data-lang="en" data-en="${u.en}" title="Ø§Ø³Ù…Ø¹ Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ">ğŸ”Š</button>
                           <button class="play-icon" data-lang="ar" data-ar="${u.ar}" title="Ø§Ø³Ù…Ø¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠ">ğŸ”ˆ</button>
                         </div>`;
        reviewList.appendChild(div);
      });
      finalMsg.style.display = 'none';
    }
    retryBtn.style.display = unique.length > 0 ? 'inline-block' : 'none';
    // attach play buttons
    attachPlayButtons();
    saveState();
  }

  retryBtn.addEventListener('click', ()=>{
    const unique = dedupeKeepOrder(mistakes);
    if(unique.length === 0){ alert('Ù…ÙÙŠØ´ ÙƒÙ„Ù…Ø§Øª ØºÙ„Ø· ğŸ‰'); return; }
    words = unique.slice();
    mistakes = [];
    current = 0;
    quizBlock.style.display = 'block';
    reviewBlock.style.display = 'none';
    feedbackEl.innerText = '';
    updateProgressBar(current, words.length);
    showQuestion();
  });

  homeBtn.addEventListener('click', resetToHome);
  homeBtnFixed.addEventListener('click', resetToHome);

  function resetToHome(){
    originalWords = originalWords.length ? originalWords.slice() : defaultWords.slice();
    words = [];
    mistakes = [];
    current = 0;
    mode = null;
    correctCount = 0;
    starsEarned = 0;
    updateStars();
    document.getElementById('hearts').style.display='flex';
    document.getElementById('icon-book').style.display='block';
    document.getElementById('subtitle').style.display='block';
    document.getElementById('divider').style.display='block';
    document.getElementById('main-title').style.display='block';
    homeControls.style.display='flex';
    modesSection.style.display='none';
    quizBlock.style.display='none';
    reviewBlock.style.display='none';
    finalMsg.style.display='none';
    feedbackEl.innerText = '';
    updateProgressBar(0, originalWords.length);
    clearState();
  }

  saveBtn.addEventListener('click', ()=>{
    saveState();
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… âœ…');
  });

  /* attach play icons in review */
  function attachPlayButtons(){
    document.querySelectorAll('.play-icon').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const lang = btn.getAttribute('data-lang');
        if(lang === 'en') speak(btn.getAttribute('data-en'),'en');
        else speak(btn.getAttribute('data-ar'),'ar');
      });
    });
  }

  /* keyboard quickstart */
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && homeControls.style.display !== 'none'){
      startBtn.click();
    }
  });

  /* ensure speak voices ready */
  if(window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = ()=>{} }

  /* save on beforeunload */
  window.addEventListener('beforeunload', ()=> { saveState(); });

  /* ===== secret button (every minute appears) ===== */
  const loveMessages = [
    "Ø¨Ø­Ø¨ÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒÙƒ ÙˆØ§Ù„Ù„Ù‡ ğŸ’–",
    "ÙŠØ®Ø±Ø§Ø§Ø§Ø§Ø§Ø§Ø´ÙŠ Ø´Ø·ÙˆÙˆÙˆÙˆÙˆÙˆØ±Ø© ğŸ˜",
    "Ù…Ø²Ø²Ø²Ù‡Ù‡ ÙˆØ´Ø§Ø·Ø±Ø© ğŸ’‹",
    "ÙŠØ®Ø±Ø§Ø´ÙŠ Ø´Ø·ÙˆØ±Ø©",
    "Ù…Ø²Ù‡ ÙˆØ´Ø§Ø·Ø±Ø©"
  ];

  function showSecretButton(){
    secretBtn.style.display = 'block';
    // auto hide after 15s if not clicked
    setTimeout(()=>{ if(secretBtn) secretBtn.style.display = 'none'; }, 15000);
  }
  // show every minute (start after 1 minute)
  setInterval(showSecretButton, 60000);
  setTimeout(showSecretButton, 60000);

  secretBtn.addEventListener('click', ()=>{
    const randomMsg = loveMessages[Math.floor(Math.random() * loveMessages.length)];
    loveText.textContent = randomMsg;
    lovePopup.style.display = 'block';
    secretBtn.style.display = 'none';
    // auto-hide popup after 1 minute? user wanted periodic; keep manual close but auto close after 10s:
    setTimeout(()=>{ lovePopup.style.display = 'none'; }, 10000);
  });

  closePopup.addEventListener('click', ()=>{
    lovePopup.style.display = 'none';
  });

  /* a quick "show when perfect" function */
  function showSecretButtonShort(){
    secretBtn.style.display = 'block';
    setTimeout(()=>{ secretBtn.style.display = 'none'; }, 10000);
  }

  /* ===== hearts floating (decor) ===== */
  const heartsBg = document.getElementById('hearts-bg');
  setInterval(()=>{
    const h = document.createElement('div');
    h.className = 'heart';
    h.innerText = 'â¤ï¸';
    const size = 12 + Math.random()*28;
    h.style.fontSize = size + 'px';
    h.style.left = (Math.random()*100) + 'vw';
    h.style.animationDuration = (6 + Math.random()*6) + 's';
    heartsBg.appendChild(h);
    setTimeout(()=> h.remove(), 9000);
  }, 600);

  /* ===== confetti + stars initial update ===== */
  function updateStars(){ for(let i=0;i<starEls.length;i++){ if(i < starsEarned) starEls[i].classList.add('active'); else starEls[i].classList.remove('active'); } }
  updateStars();

  /* ===== helper: update progress initially ===== */
  updateProgressBar(0, defaultWords.length);

  /* ===== small helper functions used earlier (declared here to avoid hoisting issues) ===== */
  // shuffle already defined above.

  /* ===== initial data ===== */
  originalWords = defaultWords.slice();
  words = originalWords.slice();

  /* ===== expose some for debugging (optional) ===== */
  window.__quiz = { saveState, loadState, clearState };

  /* ===== final small guard: ensure start buttons exist (if user copied parts in wrong order) ===== */
  // (No-op â€” all elements present now)

});
</script>
</body>
</html>
